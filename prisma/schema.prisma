generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  // directUrl = env("DIRECT_URL")
}

model companies {
  id         String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name       String
  cnpj       String?    @unique
  plan       String?    @default("starter")
  status     String?    @default("active")
  created_at DateTime?  @default(now()) @db.Timestamptz(6)
  updated_at DateTime?  @default(now()) @db.Timestamptz(6)
  users      users[]
  imports    imports[]
  contacts   contacts[]
  people     people[]
  phones     phones[]
  debts      debts[]
  conversations conversations[]
  messages    messages[]
  painel_clients painel_clients[]
}

model users {
  id         String    @id @db.Uuid
  company_id String    @db.Uuid
  name       String?
  role       String    @default("operator")
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  updated_at DateTime? @default(now()) @db.Timestamptz(6)
  companies  companies @relation(fields: [company_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  conversations conversations[]
}

model imports {
  id              String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  company_id      String      @db.Uuid
  file_name       String?
  file_type       String?
  total_records   Int?        @default(0)
  valid_records   Int?        @default(0)
  invalid_records Int?        @default(0)
  status          String?     @default("processing")
  error_log       Json?
  created_at      DateTime?   @default(now()) @db.Timestamptz(6)
  completed_at    DateTime?   @db.Timestamptz(6)
  companies       companies   @relation(fields: [company_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  contacts        contacts[]
}

model contacts {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  company_id    String    @db.Uuid
  import_id     String    @db.Uuid
  raw_data      Json      @db.JsonB
  status        String?   @default("pending") // pending, processed, failed
  error_message String?
  created_at    DateTime? @default(now()) @db.Timestamptz(6)
  processed_at  DateTime? @db.Timestamptz(6)

  companies     companies @relation(fields: [company_id], references: [id], onDelete: Cascade)
  imports       imports   @relation(fields: [import_id], references: [id], onDelete: Cascade)
}

model people {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  company_id    String    @db.Uuid
  name          String?
  cpf           String
  email         String?
  birth_date    DateTime? @db.Date
  created_at    DateTime? @default(now()) @db.Timestamptz(6)
  updated_at    DateTime? @default(now()) @db.Timestamptz(6)

  companies     companies      @relation(fields: [company_id], references: [id], onDelete: Cascade)
  phones        people_phones[]
  debts         debts[]
  conversations conversations[]

  @@unique([company_id, cpf])
}

model phones {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  company_id    String    @db.Uuid
  phone_number  String
  created_at    DateTime? @default(now()) @db.Timestamptz(6)

  companies     companies      @relation(fields: [company_id], references: [id], onDelete: Cascade)
  people        people_phones[]

  @@unique([company_id, phone_number])
}

model people_phones {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  person_id     String    @db.Uuid
  phone_id      String    @db.Uuid
  is_primary    Boolean?  @default(false)
  created_at    DateTime? @default(now()) @db.Timestamptz(6)

  person        people    @relation(fields: [person_id], references: [id], onDelete: Cascade)
  phone         phones    @relation(fields: [phone_id], references: [id], onDelete: Cascade)

  @@unique([person_id, phone_id])
}

model debts {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  company_id      String    @db.Uuid
  person_id       String    @db.Uuid
  contract_number String?
  original_amount Decimal   @db.Decimal(14, 2)
  current_amount  Decimal   @db.Decimal(14, 2)
  due_date        DateTime? @db.Date
  status          String    @default("open")
  priority_score  Int?      @default(0)
  last_contact_at DateTime? @db.Timestamptz
  next_action_at  DateTime? @db.Timestamptz
  metadata        Json?     @db.JsonB
  created_at      DateTime? @default(now()) @db.Timestamptz(6)
  updated_at      DateTime? @default(now()) @db.Timestamptz(6)

  companies       companies @relation(fields: [company_id], references: [id], onDelete: Cascade)
  person          people    @relation(fields: [person_id], references: [id], onDelete: Cascade)
  conversations   conversations[]
}

model conversations {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  company_id      String    @db.Uuid
  person_id       String    @db.Uuid
  debt_id         String?   @db.Uuid
  status          String    @default("active")
  assigned_to     String?   @db.Uuid
  started_at      DateTime? @default(now()) @db.Timestamptz(6)
  last_message_at DateTime? @db.Timestamptz(6)
  closed_at       DateTime? @db.Timestamptz(6)
  ai_context      Json?     @db.JsonB
  metadata        Json?     @db.JsonB
  created_at      DateTime? @default(now()) @db.Timestamptz(6)

  companies       companies @relation(fields: [company_id], references: [id], onDelete: Cascade)
  person          people    @relation(fields: [person_id], references: [id], onDelete: Cascade)
  debts           debts?    @relation(fields: [debt_id], references: [id])
  users           users?    @relation(fields: [assigned_to], references: [id])

  messages        messages[]
}

model messages {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  company_id          String    @db.Uuid
  conversation_id     String    @db.Uuid
  sender_type         String    // customer, ai, human
  channel             String    // whatsapp, sms, webchat, api
  content             String?
  attachments         Json?     @db.JsonB
  delivery_status     String?   @default("sent")
  external_message_id String?
  created_at          DateTime? @default(now()) @db.Timestamptz(6)

  companies           companies     @relation(fields: [company_id], references: [id], onDelete: Cascade)
  conversations       conversations @relation(fields: [conversation_id], references: [id], onDelete: Cascade)
}

model painel_clients {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  company_id   String    @db.Uuid
  company_name String?
  strategy     String?
  status       String?
  color        String?
  agent_name   String?
  phone_number String?
  account_id   String?
  inbox_id     String?
  logo_url     String?

  companies    companies @relation(fields: [company_id], references: [id], onDelete: Cascade)
  painel_agents painel_agents[]
  metadata      Json?           @default("{}") @db.JsonB
}

model painel_agents {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_id           String    @db.Uuid
  model               String?
  service_step        String?
  execution_order     Int?
  agent_identity      String?
  language_guidelines String?
  system_context      String?
  available_tools     String?
  conversation_flow   String?
  output_rules        String?
  security_rules      String?
  version             Int       @default(1)
  is_active           Boolean   @default(true)

  painel_clients      painel_clients @relation(fields: [client_id], references: [id], onDelete: Cascade)
  painel_apis         painel_apis[]
}

model painel_apis {
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  agent_id        String        @db.Uuid
  name            String
  execution_order Int?
  method          String?
  url             String?
  headers         Json?         @db.JsonB
  body            Json?         @db.JsonB
  
  painel_agents   painel_agents @relation(fields: [agent_id], references: [id], onDelete: Cascade)
}
